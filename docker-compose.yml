version: "3.9"

x-common-variables: &common-variables
  RUST_BACKTRACE: 1
  NODES: "[1, 2, 3, 4, 5]"
    #FLEX_QUORUM: "[4,2]"
  CARGO_UNSTABLE_SPARSE_REGISTRY: true

services:
  coordinator:
    build: ./coordinator/
    container_name: coordinator
    hostname: net
    environment:
      <<: *common-variables
      PORT_MAPPINGS: "[[8012,8021],[8013,8031],[8014,8041],[8015,8051],[8023,8032],[8024,8042],[8025,8052],[8034,8043],[8035,8053],[8045,8054]]"
      CLIENT_PORTS: "[8001, 8002, 8003, 8004, 8005]"
      PORT_TO_PID_MAPPING: "[[8001,1],[8002,2],[8003,3],[8004,4],[8005,5],[8012,1],[8013,1],[8014,1],[8015,1],[8021,2],[8023,2],[8024,2],[8025,2],[8031,3],[8032,3],[8034,3],[8035,3],[8041,4],[8042,4],[8043,4],[8045,4],[8051,5],[8052,5],[8053,5],[8054,5]]"
    ports:
      - "8012:8012"
      - "8013:8013"
      - "8014:8014"
      - "8015:8015"
      - "8021:8021"
      - "8023:8023"
      - "8024:8024"
      - "8025:8025"
      - "8031:8031"
      - "8032:8032"
      - "8034:8034"
      - "8035:8035"
      - "8041:8041"
      - "8042:8042"
      - "8043:8043"
      - "8045:8045"
      - "8051:8051"
      - "8052:8052"
      - "8053:8053"
      - "8054:8054"
    stdin_open: true
    tty: true
  
  s1:
    build: kv_store/
    container_name: s1
    hostname: s1
    environment:
      <<: *common-variables
      PID: 1
    depends_on:
      - coordinator

  s2:
    build: kv_store/
    container_name: s2
    hostname: s2
    environment:
      <<: *common-variables
      PID: 2
    depends_on:
      - coordinator

  s3:
    build: kv_store/
    container_name: s3
    hostname: s3
    environment:
      <<: *common-variables
      CARGO_UNSTABLE_SPARSE_REGISTRY: true
      PID: 3
    depends_on:
      - coordinator

  s4:
    build: kv_store/
    container_name: s4
    hostname: s4
    environment:
      <<: *common-variables
      PID: 4
    depends_on:
      - coordinator

  s5:
    build: kv_store/
    container_name: s5
    hostname: s5
    environment:
      <<: *common-variables
      PID: 5
    depends_on:
      - coordinator
